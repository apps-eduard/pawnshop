

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <style>
    /* Custom scrollbar that only appears when needed */
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 20px;
    }

    .custom-scrollbar:hover::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.7);
    }

    /* Custom class for fixed max height */
    .max-h-items {
      max-height: calc(100vh - 180px);
    }
  </style>

  <!-- Dashboard Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Loading State -->
    <div *ngIf="isLoading" class="flex items-center justify-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
    </div>

    <!-- Transaction Types Section (Transaction Cards) -->
    <div *ngIf="!isLoading"
      class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <button *ngFor="let type of transactionTypes"
          (click)="onTransactionTypeSelect(type)"
          [disabled]="isNavigating"
          [class]="'flex items-center space-x-3 p-4 rounded-lg border border-gray-200 dark:border-gray-700 transition-colors text-left group ' +
                   (isNavigating ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-md')">

          <div [class]="'p-3 rounded-lg transition-colors ' + type.bgColor">
            <!-- New Loan Icon -->
            <svg *ngIf="type.icon === 'plus'" class="w-6 h-6" [class]="type.iconColor" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
              </path>
            </svg>

            <!-- Additional Icon -->
            <svg *ngIf="type.icon === 'plus-circle'" class="w-6 h-6" [class]="type.iconColor" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>

            <!-- Partial Icon -->
            <svg *ngIf="type.icon === 'credit-card'" class="w-6 h-6" [class]="type.iconColor" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
            </svg>

            <!-- Redeem Icon -->
            <svg *ngIf="type.icon === 'check-circle'" class="w-6 h-6" [class]="type.iconColor" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>

            <!-- Renew Icon -->
            <svg *ngIf="type.icon === 'refresh'" class="w-6 h-6" [class]="type.iconColor" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>

            <!-- Auction Sales Icon (Gavel) -->
            <svg *ngIf="type.icon === 'gavel'" class="w-6 h-6" [class]="type.iconColor" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
              </path>
            </svg>
          </div>

          <div class="flex-1">
            <p class="font-medium text-gray-900 dark:text-white group-hover:text-primary-600 transition-colors">{{
              type.title }}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">{{ type.description }}</p>
          </div>

          <div class="text-gray-400 group-hover:text-primary-600 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </button>
      </div>
    </div>

    <!-- Main Content: Pending Appraisals (Left) and Recent Transactions (Right) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

      <!-- Pending Appraisals (Left Side) -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Pending Appraisals</h3>
          <span
            class="bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-200 px-2 py-1 rounded-full text-sm font-medium">
            {{ pendingAppraisals.length }} items
          </span>
        </div>

        <div *ngIf="pendingAppraisals.length === 0" class="text-center py-8">
          <div class="text-gray-400 mb-2">
            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4">
              </path>
            </svg>
          </div>
          <p class="text-gray-500 dark:text-gray-400">No pending appraisals</p>
          <p class="text-sm text-gray-400 dark:text-gray-500">Completed appraisals will appear here</p>
        </div>

        <div *ngIf="pendingAppraisals.length > 0" class="space-y-4">
          <div *ngFor="let appraisal of pendingAppraisals"
            (click)="testClickHandler(appraisal)"
            [class]="'border border-gray-200 dark:border-gray-700 rounded-lg p-4 transition-all ' +
                     (isNavigating ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:shadow-md hover:border-primary-300 dark:hover:border-primary-600 hover:bg-gray-50 dark:hover:bg-gray-700/50')">

            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <h4
                  class="font-medium text-gray-900 dark:text-white text-sm hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
                  {{ appraisal.pawnerName || 'Unknown Pawner' }}
                </h4>
                <p class="text-xs text-gray-500 dark:text-gray-400">ID: {{ appraisal.id }}</p>
              </div>
              <span
                class="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-1 rounded-full text-xs font-medium">
                Ready
              </span>
            </div>

            <div class="space-y-2 mb-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500 dark:text-gray-400">Item:</span>
                <span class="text-gray-900 dark:text-white font-medium">{{ appraisal.itemType || appraisal.description
                  }}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500 dark:text-gray-400">Category:</span>
                <span class="text-gray-900 dark:text-white">{{ appraisal.category }}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500 dark:text-gray-400">Appraised Value:</span>
                <span class="text-gray-900 dark:text-white font-semibold">{{
                  formatCurrency(getAppraisalValue(appraisal)) }}</span>
              </div>
            </div>

            <div class="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-gray-700">
              <span class="text-xs text-gray-400">
                {{ getTimeAgo(appraisal.createdAt) }}
              </span>
              <span class="text-xs text-primary-600 dark:text-primary-400 font-medium">
                Click to process â†’
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Transactions (Right Side) - Current Transaction -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Transactions</h3>
          <a (click)="viewAllTransactions()" class="text-primary-600 hover:text-primary-700 text-sm font-medium cursor-pointer">View All</a>
        </div>

        <!-- Empty State -->
        <div *ngIf="recentTransactions.length === 0" class="text-center py-8">
          <div class="text-gray-400 mb-2">
            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
              </path>
            </svg>
          </div>
          <p class="text-gray-500 dark:text-gray-400">No recent transactions</p>
          <p class="text-sm text-gray-400 dark:text-gray-500">Transactions will appear here</p>
        </div>

        <div *ngIf="recentTransactions.length > 0" class="space-y-4">
          <div *ngFor="let transaction of recentTransactions"
            class="border border-gray-100 dark:border-gray-700 rounded-lg">
            <!-- Main Transaction Row -->
            <div
              (click)="transaction.transactionHistory && transaction.transactionHistory.length > 1 ? toggleTransactionHistory(transaction.id, $event) : null"
              [class]="'flex items-start justify-between p-3 ' +
                       (transaction.transactionHistory && transaction.transactionHistory.length > 1 ? 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700' : '')">
              <div class="flex items-start space-x-3 flex-1">
                <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-600 dark:text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <!-- Transaction Number with History Indicator -->
                  <div class="flex items-center space-x-2 mb-1">
                    <p class="text-sm font-semibold text-primary-600 dark:text-primary-400">{{ transaction.transaction_number }}</p>
                    <span
                      [class]="'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + getTransactionTypeColor(transaction.type)">
                      {{ getTransactionTypeLabel(transaction.type) }}
                    </span>
                    <!-- History badge - Only show if there are MORE than 1 transactions (meaning there's actual history) -->
                    <span *ngIf="transaction.transactionHistory && transaction.transactionHistory.length > 1"
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                      {{ transaction.transactionHistory.length }} history
                    </span>
                    <!-- Expand/Collapse icon - Only show if there are MORE than 1 transactions -->
                    <svg *ngIf="transaction.transactionHistory && transaction.transactionHistory.length > 1"
                      [class]="'w-4 h-4 text-gray-400 transition-transform ' + (isTransactionExpanded(transaction.id) ? 'transform rotate-180' : '')"
                      fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>

                  <!-- Customer Name -->
                  <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">{{ transaction.customer_name }}</p>

                  <!-- Items -->
                  <div *ngIf="transaction.items && transaction.items.length > 0" class="mb-1">
                    <div *ngFor="let item of transaction.items; let isLast = last" class="text-xs text-gray-600 dark:text-gray-400">
                      <span class="font-medium">{{ item.categoryName || 'Category' }}</span>
                      <span *ngIf="item.descriptionName"> - {{ item.descriptionName }}</span>
                      <span *ngIf="item.appraisalNotes" class="text-gray-500"> ({{ item.appraisalNotes }})</span>
                    </div>
                  </div>

                  <!-- Time Ago -->
                  <p class="text-xs text-gray-500 dark:text-gray-400">{{ getTimeAgo(transaction.created_at) }}</p>
                </div>
              </div>
              <div class="text-right flex-shrink-0 ml-3">
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">{{ getAmountLabel(transaction.type) }}</div>
                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ formatCurrency(transaction.amount) }}</p>
                <span
                  [class]="'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + getStatusColor(transaction.status)">
                  {{ transaction.status | titlecase }}
                </span>
              </div>
            </div>

            <!-- Transaction History (Expandable) - Only show if there are MORE than 1 transactions -->
            <div *ngIf="isTransactionExpanded(transaction.id) && transaction.transactionHistory && transaction.transactionHistory.length > 1"
              class="px-3 pb-3 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
              <div class="mt-3 space-y-2">
                <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Transaction History:</p>
                <div *ngFor="let history of transaction.transactionHistory"
                  class="flex items-center justify-between py-2 px-3 bg-white dark:bg-gray-700 rounded-lg">
                  <div class="flex-1">
                    <div class="flex items-center space-x-2">
                      <span class="text-xs font-medium text-gray-900 dark:text-white">{{ history.transactionNumber }}</span>
                      <span [class]="'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + getTransactionTypeColor(history.transactionType)">
                        {{ getTransactionHistoryTypeLabel(history.transactionType) }}
                      </span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ getTimeAgo(history.createdAt) }}</p>
                  </div>
                  <div class="text-right ml-3">
                    <p class="text-xs font-medium text-gray-900 dark:text-white" *ngIf="history.transactionType === 'partial_payment'">
                      New Principal: {{ formatCurrency(history.newPrincipalLoan) }}
                    </p>
                    <p class="text-xs text-gray-600 dark:text-gray-400" *ngIf="history.transactionType === 'partial_payment'">
                      Amount Due: {{ formatCurrency(history.totalAmount) }}
                    </p>
                    <p class="text-xs text-green-600 dark:text-green-400" *ngIf="history.transactionType === 'partial_payment'">
                      Partial Pay: {{ formatCurrency(history.amountPaid) }}
                    </p>
                    <!-- For other transaction types, show original format -->
                    <p class="text-xs font-medium text-gray-900 dark:text-white" *ngIf="history.transactionType !== 'partial_payment'">
                      <span *ngIf="history.amountPaid">Paid: {{ formatCurrency(history.amountPaid) }}</span>
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400" *ngIf="history.transactionType !== 'partial_payment'">
                      Balance: {{ formatCurrency(history.balance) }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
