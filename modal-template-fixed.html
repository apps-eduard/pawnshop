<!-- New Appraisal Modal -->
<div *ngIf="showNewAppraisalModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-[98vw] h-[98vh] flex flex-col">
    <!-- Modal Header -->
    <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        New Appraisal
      </h3>
      <button
        (click)="closeNewAppraisalModal()"
        title="Close Modal"
        class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="flex-grow overflow-hidden">
      <div class="grid grid-cols-2 h-full">
    
        <!-- LEFT COLUMN: Pawner Info + Added Items -->
        <div class="p-6 border-r border-gray-200 dark:border-gray-700 h-full flex flex-col">
        
          <!-- Pawner Information (scrollable top section) -->
          <div class="flex-1 overflow-y-auto pr-2">
            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">Pawner Information</h4>

            <!-- Pawner Form -->
            <div *ngIf="showCreatePawnerForm" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-3 overflow-y-auto max-h-72">
              <h4 class="font-medium text-gray-900 dark:text-gray-300 mb-3">Create New Pawner</h4>
              <form (ngSubmit)="createPawner()" class="space-y-4">
                <!-- Name Fields -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      First Name <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      [(ngModel)]="newPawner.firstName"
                      name="firstName"
                      required
                      title="Enter pawner's first name"
                      placeholder="First name"
                      class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                      Last Name <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      [(ngModel)]="newPawner.lastName"
                      name="lastName"
                      required
                      title="Enter pawner's last name"
                      placeholder="Last name"
                      class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white text-sm">
                  </div>
                </div>

                <!-- Contact Information -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                      Contact Number <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="tel"
                      [(ngModel)]="newPawner.contactNumber"
                      name="contactNumber"
                      required
                      class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white text-sm"
                      placeholder="+63 900 000 0000">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">Email</label>
                    <input
                      type="email"
                      [(ngModel)]="newPawner.email"
                      name="email"
                      class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white text-sm"
                      placeholder="optional">
                  </div>
                </div>

                <!-- Address Information -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                      City <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-2">
                      <select
                        [(ngModel)]="newPawner.cityId"
                        name="cityId"
                        (change)="onCityChange()"
                        required
                        title="Select a city"
                        class="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Select City</option>
                        <option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</option>
                      </select>
                      <button
                        type="button"
                        (click)="showAddCityDialog()"
                        class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors flex items-center justify-center"
                        title="Add New City">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">Barangay</label>
                    <div class="flex gap-2">
                      <select
                        [(ngModel)]="newPawner.barangayId"
                        name="barangayId"
                        [disabled]="!newPawner.cityId"
                        title="Select a barangay"
                        class="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white disabled:bg-gray-100 disabled:dark:bg-gray-600">
                        <option value="">Select Barangay</option>
                        <option *ngFor="let barangay of filteredBarangays" [value]="barangay.id">{{ barangay.name }}</option>
                      </select>
                      <button
                        type="button"
                        (click)="showAddBarangayDialog()"
                        [disabled]="!newPawner.cityId"
                        class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors flex items-center justify-center disabled:bg-gray-400"
                        title="Add New Barangay">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">Address Details</label>
                  <textarea
                    [(ngModel)]="newPawner.addressDetails"
                    name="addressDetails"
                    rows="2"
                    class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Street, house number, etc."></textarea>
                </div>

                <!-- Create Pawner button removed as requested -->
              </form>
            </div>

            <!-- Selected Pawner Info (if available) -->
            <div *ngIf="selectedPawner" class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800 mb-4">
              <div class="flex justify-between">
                <h4 class="font-medium text-green-900 dark:text-green-300">Existing Pawner Selected:</h4>
                <button
                  (click)="clearSelection()"
                  class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300"
                  title="Clear selection">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <div class="mt-2 text-sm text-green-800 dark:text-green-400">
                <p class="font-bold">{{ selectedPawner.firstName }} {{ selectedPawner.lastName }}</p>
                <p><span class="font-semibold">Contact:</span> {{ selectedPawner.contactNumber }}</p>
                <p *ngIf="selectedPawner.email"><span class="font-semibold">Email:</span> {{ selectedPawner.email }}</p>
                <p *ngIf="selectedPawner.cityName || selectedPawner.barangayName">
                  <span class="font-semibold">Address:</span> {{ selectedPawner.barangayName ? selectedPawner.barangayName + ', ' : '' }}{{ selectedPawner.cityName }}
                </p>
              </div>
            </div>
          </div>
          
          <!-- Added Items (bottom section) -->
          <div class="mt-3 border-t pt-3 overflow-y-auto max-h-[40%]">
            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">Added Items</h4>
            <div *ngIf="appraisalItems.length > 0">
              <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-3">
                <div class="overflow-x-auto">
                  <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700">
                    <thead>
                      <tr class="bg-gray-100 dark:bg-gray-700">
                        <th class="py-1 px-2 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Category</th>
                        <th class="py-1 px-2 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Description</th>
                        <th class="py-1 px-2 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Value</th>
                        <th class="py-1 px-2 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of appraisalItems; let i = index" class="border-t border-gray-200 dark:border-gray-700">
                        <td class="py-1 px-2 text-sm">
                          <span class="font-medium">{{ item.category }}</span>
                          <span *ngIf="item.categoryDescription" class="block text-xs text-gray-500 dark:text-gray-400">{{ item.categoryDescription }}</span>
                        </td>
                        <td class="py-1 px-2 text-sm">{{ item.description }}</td>
                        <td class="py-1 px-2 text-sm">₱{{ item.estimatedValue | number:'1.2-2' }}</td>
                        <td class="py-1 px-2 text-center">
                          <button (click)="removeItemFromAppraisal(i)" class="text-red-500 hover:text-red-700" title="Remove Item">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr class="bg-gray-50 dark:bg-gray-700 font-medium">
                        <td colspan="2" class="py-1 px-2 text-right text-sm">Total Value:</td>
                        <td class="py-1 px-2 text-sm font-bold">₱{{ calculateTotalValue() | number:'1.2-2' }}</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <!-- Save All Appraisals Button -->
                <div class="mt-2">
                  <button
                    (click)="saveAppraisal()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white py-1.5 rounded-lg font-medium transition-colors flex items-center justify-center">
                    <span>{{ selectedPawner ? 'Save All Items' : 'Save (Select Pawner First)' }}</span>
                  </button>
                </div>

                <!-- Warning message if no pawner selected -->
                <div *ngIf="!selectedPawner && !showCreatePawnerForm" class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded-md">
                  <p class="text-xs text-yellow-700">Please select or create a pawner before saving these items.</p>
                </div>
              </div>
            </div>

            <!-- No items message -->
            <div *ngIf="appraisalItems.length === 0" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center text-gray-500 dark:text-gray-400 mt-3">
              <p>No items added yet. Add items from the form on the right.</p>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: Item Information -->
        <div class="p-6 overflow-y-auto h-full">
          <div class="flex justify-between items-center mb-2">
            <h4 class="text-md font-medium text-gray-900 dark:text-white">Item Information</h4>
            <span *ngIf="selectedPawner" 
                  class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
              Adding item for {{ selectedPawner.firstName }} {{ selectedPawner.lastName }}
            </span>
            <span *ngIf="!selectedPawner && showCreatePawnerForm" 
                  class="text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">
              Fill pawner details first
            </span>
          </div>

          <!-- Item Form -->
          <div *ngIf="showItemForm" 
              class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-3 overflow-y-auto flex-grow">
            <form (ngSubmit)="saveItemAppraisal()" class="space-y-2">
              <!-- Category -->
              <div>
                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                  Category <span class="text-red-500">*</span>
                </label>
                <select
                  [(ngModel)]="currentItem.category"
                  name="category"
                  (change)="onCategoryChange()"
                  required
                  aria-label="Select item category"
                  title="Select item category"
                  class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select Category</option>
                  <option *ngFor="let category of categories" [value]="category.name">{{ category.name }} ({{ (category.interestRate * 100) | number:'1.0-2' }}% interest)</option>
                </select>
              </div>

              <!-- Rest of the item form - match with your current implementation -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                    Description <span class="text-red-500">*</span>
                  </label>
                  <div class="flex gap-2">
                    <select
                      [(ngModel)]="currentItem.categoryDescription"
                      name="categoryDescription"
                      [disabled]="!currentItem.category || isLoadingDescriptions"
                      aria-label="Select item description"
                      class="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white disabled:bg-gray-100 dark:disabled:bg-gray-600 disabled:cursor-not-allowed">
                      <option value="">{{ isLoadingDescriptions ? 'Loading descriptions...' : (currentItem.category ? (filteredCategoryDescriptions.length ? 'Select Description' : 'No descriptions available') : 'Select a category first') }}</option>
                      <option *ngFor="let desc of filteredCategoryDescriptions" [value]="desc.description">{{ desc.description }}</option>
                    </select>
                    <button
                      *ngIf="currentItem.category"
                      type="button"
                      (click)="openAddCategoryDescriptionDialog()"
                      title="Add new description"
                      class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors flex items-center justify-center">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                      </svg>
                    </button>
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                    Detailed Description
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="currentItem.description"
                    name="description"
                    class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"
                    placeholder="e.g., 14K Gold Ring with Ruby">
                </div>
              </div>

              <!-- Additional Fields -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                    Estimated Value <span class="text-red-500">*</span>
                  </label>
                  <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <span class="text-gray-500 sm:text-sm">₱</span>
                    </div>
                    <input
                      type="number"
                      [(ngModel)]="currentItem.estimatedValue"
                      name="estimatedValue"
                      required
                      min="1"
                      class="w-full pl-7 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"
                      placeholder="0.00">
                  </div>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Appraised value in Philippine Peso</p>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                    Serial Number
                  </label>
                  <input
                    type="text"
                    [(ngModel)]="currentItem.serialNumber"
                    name="serialNumber"
                    title="Item Serial Number"
                    class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Optional">
                </div>
              </div>

              <!-- Jewelry Specific Fields -->
              <div *ngIf="currentItem.category && currentItem.category.toLowerCase().includes('jewelry')" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                    Weight (grams)
                  </label>
                  <input
                    type="number"
                    [(ngModel)]="currentItem.weight"
                    name="weight"
                    step="0.01"
                    min="0"
                    class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Weight in grams">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                    Karat
                  </label>
                  <input
                    type="number"
                    [(ngModel)]="currentItem.karat"
                    name="karat"
                    min="1"
                    max="24"
                    class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"
                    placeholder="Enter karat value (1-24)"
                    title="Enter karat value">
                </div>
              </div>

              <!-- Notes -->
              <div>
                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-0.5">
                  Notes
                </label>
                <textarea
                  [(ngModel)]="currentItem.notes"
                  name="notes"
                  rows="2"
                  class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"
                  placeholder="Condition notes, identifying marks, etc."></textarea>
              </div>

              <!-- Submit Button -->
              <div class="pt-2">
                <button
                  type="submit"
                  [disabled]="!currentItem.category || !currentItem.estimatedValue || isSavingItem"
                  class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-1.5 rounded-lg font-medium transition-colors flex items-center justify-center"
                  title="Add item to appraisal">
                  <svg *ngIf="isSavingItem" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span>{{ isSavingItem ? 'Adding...' : 'Add Item' }}</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>